---
import appExtras from '../data/apps-extra.json';
import AppsExtra from './_apps-extra.astro';
/// import AppsHeatmap from './_apps-heatmap.astro';
import {SITE} from '~/config.mjs';
import Layout from '~/layouts/PageLayout.astro';
import OverflowMenu from '~/components/widgets/OverflowMenu.astro';
import {fetchApps, proseCSS, tagCSS as tagClass} from '~/utils/apps.js';

const meta = {
	title: `Apps — ${SITE.name}`,
	description: 'Quality crafted apps by Sindre Sorhus',
};

const allApps = await fetchApps({includeArchived: true});
const apps = allApps.filter(app => !app.isArchived);
const oldestPubDate = Math.min(...allApps.map(app => app.pubDate));
const yearsOfCraft = new Date().getFullYear() - new Date(oldestPubDate).getFullYear();
---

<Layout {meta}>
	<div class="bg-slate-50 dark:bg-inherit">
		<section class="container sm:px-6 py-16 sm:py-16 lg:py-20 mx-auto">
			<header class="text-center mb-5 md:mb-16">
				<!-- TODO: Make title components -->
				<h1 class="flex flex-col sm:flex-row sm:flex-wrap items-center justify-center gap-3 text-center text-[2.5rem] sm:text-5xl md:text-7xl font-bold leading-tighter tracking-tighter mb-6 font-heading">
					<span class="flex flex-wrap items-center justify-center gap-2">
						<span>Quality Crafted</span>
						<span class="bg-clip-text text-transparent bg-linear-to-r from-primary-500 to-secondary-500 pr-[0.025em] mr-[-0.025em]">Apps</span>
					</span>
					<div class="inline-flex mt-1 sm:mt-0 translate-y-0 scale-[1.25] sm:translate-x-2 sm:translate-y-[4px] sm:scale-[1.2] md:translate-y-[7px]">
						<OverflowMenu iconClassName="text-secondary-400 dark:text-secondary-400" iconSizeClass="w-7 h-7 sm:w-5 sm:h-5">
							{appExtras.map(group => (
								<optgroup label={group.label}>
									{group.items.map(item => (
										<option value={item.url}>{item.title}</option>
									))}
								</optgroup>
							))}
						</OverflowMenu>
					</div>
				</h1>
				<p class="flex flex-col md:flex-row md:items-center justify-center gap-y-1 md:gap-y-0 text-slate-500 dark:text-slate-500 text-sm font-mono tracking-wide" style="font-variant-numeric: oldstyle-nums tabular-nums">
					<span>{allApps.length} apps</span>
					<span class="hidden md:inline mx-2 opacity-50">·</span>
					<span>{yearsOfCraft} years of craft</span>
					<span class="hidden md:inline mx-2 opacity-50">·</span>
					<span>6 million users</span>
					<span class="hidden md:inline mx-2 opacity-50">·</span>
					<span>10K answered support emails</span>
				</p>
			</header>
			<section data-nosnippet class="mx-auto grid sm:gap-12 grid-cols-1 lg:grid-cols-2 sm:p-1 mt-6 mb-12 sm:my-12 dark:text-white">
				{
					apps.map(app => (
						<a
							href={app.url}
							class="flex py-6 px-2 sm:p-6 bg-white dark:bg-black/20 sm:rounded-xl shadow-md dark:shadow-lg sm:border sm:border-transparent dark:sm:border-slate-800 sm:hover:border-indigo-200/70 dark:sm:hover:border-indigo-500/30 sm:hover:bg-indigo-50/40 dark:sm:hover:bg-indigo-950/20 hover:shadow-xl dark:sm:hover:shadow-indigo-500/20 sm:hover:-translate-y-0.5 transition duration-300"
						>
							<div class="flex-initial shrink-0 justify-center mr-2 sm:mr-3">
								<img src={app.iconUrl} width="128" height="128" alt={`${app.title} app icon`} loading="lazy" class="p-[12px] drop-shadow-[0_2px_2px_rgba(0,0,0,0.1)]">
							</div>
							<div class="flex flex-col justify-center my-3 mr-2 sm:mt-[-1px]">
								<div class="mb-0.5 text-2xl sm:text-3xl font-bold">{app.title}</div>
								<div class="text-gray-700 dark:text-gray-200/90 text-lg sm:text-xl sm:leading-tight leading-tight" style="text-wrap: pretty; hanging-punctuation: first last">{app.subtitle}</div>
								<div class="flex flex-wrap gap-1.5 mt-3 sm:mt-3 opacity-90">
									{app.isNew && (
										<span class={`${tagClass} bg-teal-100 dark:bg-teal-200`}>new!</span>
									)}
									<span class={`${tagClass} bg-gray-200/80 dark:bg-gray-200`}>{app.isPaid ? 'paid' : 'free'}</span>
									{app.repoUrl && (
										<span class={`${tagClass} bg-gray-200/80 dark:bg-gray-200`}>open-source</span>
									)}
									{app.platforms.map(platform => (
										<span class={`${tagClass} bg-sky-100/90 dark:bg-sky-200`}>{platform}</span>
									))}
								</div>
							</div>
						</a>
					))
				}
			</section>
			{/* <AppsHeatmap apps={allApps}/> */}
			<section data-nosnippet class={proseCSS} style="margin-top: 120px; margin-bottom: 60px">
				<AppsExtra/>
			</section>
		</section>
	</div>
	<script type="application/ld+json" set:html={JSON.stringify({
		'@context': 'https://schema.org',
		'@type': 'ItemList',
		name: 'Sindre Sorhus Apps',
		description: 'Quality crafted apps by Sindre Sorhus',
		url: 'https://sindresorhus.com/apps',
		numberOfItems: apps.length,
		itemListElement: apps.map((app, index) => ({
			'@type': 'ListItem',
			position: index + 1,
			item: {
				'@type': 'SoftwareApplication',
				name: app.title,
				description: app.subtitle,
				url: `https://sindresorhus.com${app.url}`,
				applicationCategory: app.platforms.includes('macOS') ? 'UtilitiesApplication' : 'MobileApplication',
				operatingSystem: app.platforms.join(', '),
				author: {
					'@type': 'Person',
					name: 'Sindre Sorhus',
				},
				...(app.appStoreId && {downloadUrl: app.appStoreUrl}),
			},
		})),
	}, null, '\t')} />
</Layout>
